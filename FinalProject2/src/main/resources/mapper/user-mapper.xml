<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="user">

	<select id="selectUserWithEmail" parameterType="string" resultType="map">
		SELECT * FROM (SELECT * FROM TB_USER_ACTIVE WHERE USER_EMAIL=#{email}) LEFT JOIN TB_USER USING(USER_NO) LEFT JOIN TB_BASIC_USER USING(USER_NO) LEFT JOIN TB_NAVER_USER USING(USER_NO)
	</select>
	
	<insert id="insertUser" parameterType="map">
		<selectKey order="BEFORE" resultType="_int" keyProperty="USER_NO">SELECT SEQ_USER_NO.NEXTVAL FROM DUAL </selectKey>
			INSERT ALL 
				INTO TB_USER VALUES(#{USER_NO}, 1) 
				INTO TB_USER_ACTIVE VALUES(#{USER_NO}, #{USER_EMAIL}, #{USER_NAME}, SYSDATE , '/resources/upload/userProfilePhoto/user_Inform.png' , #{USER_LINK_TYPE}) 
			<choose>
				<when test="USER_LINK_TYPE == 1">INTO TB_BASIC_USER VALUES(#{USER_NO},#{USER_PASSWORD}) </when>
				<when test="USER_LINK_TYPE == 2">INTO TB_NAVER_USER VALUES(#{USER_NO},#{USER_PASSWORD}) </when>
			</choose>
			SELECT * FROM DUAL 
	</insert>
	
	<select id='selectUserWithNo' parameterType="_int" resultType="map">
		SELECT * FROM (SELECT * FROM TB_USER_ACTIVE WHERE USER_NO=#{userNo}) LEFT JOIN TB_USER USING(USER_NO) LEFT JOIN TB_BASIC_USER USING(USER_NO) LEFT JOIN TB_NAVER_USER USING(USER_NO)
	</select>
	
	<select id="selectUserAddressList" parameterType="_int" resultType="map">
		SELECT * FROM TB_USER_ADDRESS WHERE USER_NO=#{userNo}
	</select>
	
	<select id="selectUserAccountList" parameterType="_int" resultType="map">
		SELECT * FROM TB_USER_ACCOUNT WHERE USER_NO=#{userNo}
	</select>
	
	<select id="selectUserFundingList" parameterType="map" resultType="map">
		SELECT D.*,REWARD_DEADLINE-TRUNC(SYSDATE) as REWARD_REMAIN_DATE,
            NVL((SELECT SUM((A.REWARD_SUPPORT_NUM*B.REWARD_ITEM_PRICE)+C.REWARD_SUPPORT_ADD_DONATION) FROM TB_REWARD_SUPPORT_ITEM A INNER JOIN TB_REWARD_ITEM B ON A.REWARD_ITEM_NO=B.REWARD_ITEM_NO INNER JOIN (SELECT DISTINCT * FROM TB_REWARD_SUPPORT) C ON A.REWARD_SUPPORT_NO=C.REWARD_SUPPORT_NO WHERE D.REWARD_NO=A.REWARD_NO GROUP BY A.REWARD_NO),0) AS REWARD_PRESENT_COLLECTION,
            NVL(FLOOR(((SELECT SUM((A.REWARD_SUPPORT_NUM*B.REWARD_ITEM_PRICE)+C.REWARD_SUPPORT_ADD_DONATION) FROM TB_REWARD_SUPPORT_ITEM A INNER JOIN TB_REWARD_ITEM B ON A.REWARD_ITEM_NO=B.REWARD_ITEM_NO INNER JOIN TB_REWARD_SUPPORT C ON A.REWARD_SUPPORT_NO=C.REWARD_SUPPORT_NO WHERE D.REWARD_NO=A.REWARD_NO GROUP BY A.REWARD_NO)/REWARD_GOAL)*100),0) AS REWARD_ACHIEVEMENT_PERSENT,
            E.REWARD_CATEGORY_NAME,
            D.REWARD_START_DATE-TRUNC(SYSDATE) as REWARD_OPEN_DATE 
		FROM TB_REWARD D INNER JOIN TB_REWARD_CATEGORY E ON D.REWARD_CATEGORY_NO=E.REWARD_CATEGORY_NO WHERE REWARD_NO in (SELECT REWARD_NO FROM TB_REWARD_SUPPORT WHERE USER_NO = #{userNo})
		<choose>
			<when test='filter == 1'>
				AND REWARD_STATE in (3 , 4)
			</when>
			<when test='filter == 2'>
				AND REWARD_STATE in (5, 6)
			</when>
		</choose>
	</select>
	
	<select id="selectUserMadeFundingList" parameterType="map" resultType="map">
		SELECT D.*,REWARD_DEADLINE-TRUNC(SYSDATE) as REWARD_REMAIN_DATE,
            NVL((SELECT SUM((A.REWARD_SUPPORT_NUM*B.REWARD_ITEM_PRICE)+C.REWARD_SUPPORT_ADD_DONATION) FROM TB_REWARD_SUPPORT_ITEM A INNER JOIN TB_REWARD_ITEM B ON A.REWARD_ITEM_NO=B.REWARD_ITEM_NO INNER JOIN (SELECT DISTINCT * FROM TB_REWARD_SUPPORT) C ON A.REWARD_SUPPORT_NO=C.REWARD_SUPPORT_NO WHERE D.REWARD_NO=A.REWARD_NO GROUP BY A.REWARD_NO),0) AS REWARD_PRESENT_COLLECTION,
            NVL(FLOOR(((SELECT SUM((A.REWARD_SUPPORT_NUM*B.REWARD_ITEM_PRICE)+C.REWARD_SUPPORT_ADD_DONATION) FROM TB_REWARD_SUPPORT_ITEM A INNER JOIN TB_REWARD_ITEM B ON A.REWARD_ITEM_NO=B.REWARD_ITEM_NO INNER JOIN TB_REWARD_SUPPORT C ON A.REWARD_SUPPORT_NO=C.REWARD_SUPPORT_NO WHERE D.REWARD_NO=A.REWARD_NO GROUP BY A.REWARD_NO)/REWARD_GOAL)*100),0) AS REWARD_ACHIEVEMENT_PERSENT,
            E.REWARD_CATEGORY_NAME,
            D.REWARD_START_DATE-TRUNC(SYSDATE) as REWARD_OPEN_DATE 
			FROM TB_REWARD D INNER JOIN TB_REWARD_CATEGORY E ON D.REWARD_CATEGORY_NO=E.REWARD_CATEGORY_NO WHERE USER_NO=#{userNo}
		<choose>
			<when test='filter == 1'>
				AND REWARD_STATE in (3 , 4)
			</when>
			<when test='filter == 2'>
				AND REWARD_STATE in (5, 6)
			</when>
		</choose>
	</select>
	
	<select id="selectUserLikeFundingList" parameterType="map" resultType="map">
		SELECT D.*,REWARD_DEADLINE-TRUNC(SYSDATE) as REWARD_REMAIN_DATE,
            NVL((SELECT SUM((A.REWARD_SUPPORT_NUM*B.REWARD_ITEM_PRICE)+C.REWARD_SUPPORT_ADD_DONATION) FROM TB_REWARD_SUPPORT_ITEM A INNER JOIN TB_REWARD_ITEM B ON A.REWARD_ITEM_NO=B.REWARD_ITEM_NO INNER JOIN (SELECT DISTINCT * FROM TB_REWARD_SUPPORT) C ON A.REWARD_SUPPORT_NO=C.REWARD_SUPPORT_NO WHERE D.REWARD_NO=A.REWARD_NO GROUP BY A.REWARD_NO),0) AS REWARD_PRESENT_COLLECTION,
            NVL(FLOOR(((SELECT SUM((A.REWARD_SUPPORT_NUM*B.REWARD_ITEM_PRICE)+C.REWARD_SUPPORT_ADD_DONATION) FROM TB_REWARD_SUPPORT_ITEM A INNER JOIN TB_REWARD_ITEM B ON A.REWARD_ITEM_NO=B.REWARD_ITEM_NO INNER JOIN TB_REWARD_SUPPORT C ON A.REWARD_SUPPORT_NO=C.REWARD_SUPPORT_NO WHERE D.REWARD_NO=A.REWARD_NO GROUP BY A.REWARD_NO)/REWARD_GOAL)*100),0) AS REWARD_ACHIEVEMENT_PERSENT,
            E.REWARD_CATEGORY_NAME,
            D.REWARD_START_DATE-TRUNC(SYSDATE) as REWARD_OPEN_DATE 
		FROM TB_REWARD D INNER JOIN TB_REWARD_CATEGORY E ON D.REWARD_CATEGORY_NO=E.REWARD_CATEGORY_NO WHERE REWARD_NO in (SELECT REWARD_NO FROM TB_REWARD_LIKE WHERE USER_NO = #{userNo})
		<choose>
			<when test='filter == 1'>
				AND REWARD_STATE in (3 , 4)
			</when>
			<when test='filter == 2'>
				AND REWARD_STATE in (5, 6)
			</when>
		</choose>
	</select>
	
	<update id="updateUserPhoto" parameterType="map">
		UPDATE TB_USER_ACTIVE SET USER_PROFILEPHOTO = #{USER_PROFILEPHOTO} WHERE USER_NO = #{USER_NO}
	</update>
	<update id='updateUserName' parameterType="map">
		UPDATE TB_USER_ACTIVE SET USER_NAME = #{USER_NAME} WHERE USER_NO = #{USER_NO}
	</update>
	<insert id='insertOutUser' parameterType='map'>
		INSERT INTO TB_USER_OUT(USER_EMAIL, USER_NO, USER_OUT_REASON) VALUES((SELECT USER_EMAIL FROM TB_USER_ACTIVE WHERE USER_NO =#{userNo}), #{userNo},#{outReason})
	</insert>
	<delete id="deleteUserPw" parameterType="map">
		DELETE FROM 
		<choose>
			<when test="USER_LINK_TYPE == 1"> TB_BASIC_USER </when>
			<when test="USER_LINK_TYPE == 2"> TB_NAVER_USER </when>
		</choose>
		WHERE USER_NO = #{userNo}
	</delete>
	<delete id="deleteUserAllAddress" parameterType="_int">
		DELETE FROM TB_USER_ADDRESS WHERE USER_NO = #{userNo}
	</delete>
	<delete id="deleteActiveUser" parameterType="_int">
		DELETE FROM TB_USER_ACTIVE WHERE USER_NO = #{userNo}
	</delete>
	<update id="updateOutUser" parameterType="_int">
		UPDATE TB_USER SET USER_TYPE = 2 WHERE USER_NO=#{userNo}
	</update>
	<select id='selectEqualEmail' parameterType="string" resultType="_int">
		SELECT COUNT(USER_EMAIL) FROM (SELECT USER_EMAIL FROM TB_USER_ACTIVE UNION SELECT USER_EMAIL FROM TB_USER_OUT) WHERE USER_EMAIL=#{email} 
	</select>
	<select id="selectUserLinkType" parameterType="string" resultType="_int">
		SELECT USER_LINK_TYPE FROM TB_USER_ACTIVE WHERE USER_EMAIL=#{email}
	</select>
	<insert id="insertUserTemp" parameterType="map">
		INSERT INTO TB_USER_TEMP VALUES(#{tempKey},#{userNo}, DEFAULT)
	</insert>
	<select id="selectUserTemp" parameterType="string" resultType="map">
		SELECT * FROM TB_USER_TEMP WHERE TEMP_KEY = #{key}
	</select>
	<update id="updateUserPassword" parameterType="map">
		UPDATE TB_BASIC_USER SET USER_PASSWORD = #{password} WHERE USER_NO = #{userNo}
	</update>
	<delete id="deleteUserTemp" parameterType="_int">
		DELETE FROM TB_USER_TEMP WHERE USER_NO = #{userNo}
	</delete>
	<update id="updateUserEmail" parameterType="map">
		UPDATE TB_USER_ACTIVE SET USER_EMAIL = #{email} WHERE USER_NO = #{userNo}
	</update>
	<delete id='deleteUserAddress' parameterType="_int">
		DELETE FROM TB_USER_ADDRESS WHERE ADDRESS_NO = #{addrNo}
	</delete>
	<insert id="addAddress" parameterType="map">
		<selectKey order="BEFORE" resultType="_int" keyProperty="ADDRESS_NO">SELECT SEQ_USER_ADDRESS_NO.NEXTVAL FROM DUAL </selectKey>
		INSERT INTO TB_USER_ADDRESS VALUES(#{ADDRESS_NO},#{userNo},#{addrName},#{zipNo},#{addrWhole},#{addrDetail},#{phone},#{receiver})
	</insert>
</mapper>
